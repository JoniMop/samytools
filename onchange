#!/usr/bin/perl

# run a command every X seconds when a file/dir changes
# -samy kamkar
#
# eg: onchange project/ rsync -av project/ remote.com:proj

my ($secs, $files, $commands) = usage();

my @files = @{$files};
my @commands = @{$commands};
my (%last, %mtime);
while (1)
{
	my $change;
	foreach my $file (@files)
	{
		($mtime{$file}) = (stat($file))[9];
		if ($last{$file} != $mtime{$file})
		{
			$change++;
			$last{$file} = $mtime{$file};
		}
	}

	if ($change)
	{
		print "\$ @commands\n";
		system(@command);
	}
	select(undef, undef, undef, $secs);
}

sub usage
{
	$|++;
	my $secs = 0.1;
	if ($ARGV[0] =~ /^\d+$/)
	{
		$secs = shift(@ARGV);
	}

	my @files;
	push(@files, shift(@ARGV)) while (-e $ARGV[0]);

	#my $file = -e $ARGV[-1] && !-e $ARGV[0] ? $ARGV[-1] : shift(@ARGV);
	my @command = @ARGV;

	if (!@files || !@command)
	{
		die "usage: $0 [secs] [files/dirs] <command to run on change>\n";
	}

	return ($secs, \@files, \@command);
}
